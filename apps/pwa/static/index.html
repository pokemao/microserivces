<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="/notifi/manifest.json" />
    <title>Service Worker测试页面</title>
    <style>
      body {
        font-family: monospace;
        font-size: 1rem;
        white-space: pre-wrap;
      }
      #install {
        width: 100px;
        height: 30px;
        background-color: #007bff;
        color: #fff;
        text-align: center;
        line-height: 30px;
        cursor: pointer;
      }
      #front_notification {
        width: 200px;
        height: 30px;
        background-color: #007bff;
        color: #fff;
        text-align: center;
        line-height: 30px;
        cursor: pointer;
      }
      #front_service_notification {
        width: 200px;
        height: 30px;
        background-color: #007bff;
        color: #fff;
        text-align: center;
        line-height: 30px;
        cursor: pointer;
      }
    </style>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  </head>
  <body>
    <h1>测试 Service Worker</h1>
    <div id="install">下载PWA</div>
    <br />
    <div id="front_notification">发送前端通知</div>
    <br />
    <div id="front_service_notification">发送前端service通知</div>

    <p>This demo shows how to send push notifications with a payload.</p>

    <form>
    Notification payload: <input id='notification-payload' type='text' value='Insert here a payload'></input>
    Notification delay: <input id='notification-delay' type='number' value='5'></input> seconds
    Notification Time-To-Live: <input id='notification-ttl' type='number' value='0'></input> seconds
    </form>

    <button id="doIt">Request sending a notification!</button>

    <script>
      // VConsole 默认会挂载到 `window.VConsole` 上
      var vConsole = new window.VConsole();
      // 接下来即可照常使用 `console` 等方法
      console.log("Hello world");
    </script>
    <script>
      console.log('shaoshaoshaoshao3333');

      // 注册 Service worker
      if ("serviceWorker" in window.navigator) {
        const registerServiceWorker = async () => {
          if ("serviceWorker" in navigator) {
            try {
              const registration = await navigator.serviceWorker.register(
                "/notifi/background.js",
                {
                  scope: "/notifi/",
                }
              );
              console.log(
                "index.html navigator.serviceWorker.register: ",
                registration
              );
              if (registration.installing) {
                console.log("index.html 正在安装 Service worker");
              } else if (registration.waiting) {
                console.log("index.html 已安装 Service worker installed");
              } else if (registration.active) {
                console.log("index.html 激活 Service worker");
              }
            } catch (error) {
              console.error(`index.html 注册失败：${error}`);
            }
          }
        };

        registerServiceWorker();
      }

      // pwa 安装
      let pwa = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        console.log("index.html 浏览器支持beforeinstallprompt");
        pwa = e;
      });
      const install = document.querySelector("#install");
      install.addEventListener("click", () => {
        if (pwa) {
          pwa.prompt();
        } else {
          alert("浏览器不支持PWA");
        }
      });

      // 发送通知
      const options = {
        body: "You successfully subscribed to our FRONTEND Notification service!",
        tag: "confirm-notification",
      };
      const frontNotificationPush = () => {
        new Notification("frontNotificationPush", options);
      };
      const frontNotification = document.querySelector("#front_notification");
      frontNotification.addEventListener("click", () => {
        if (Notification.permission === "default") {
          console.log("index.html 没有权限");
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              frontNotificationPush();
            } else {
              alert("请允许通知");
            }
          });
        } else if (Notification.permission === "granted") {
          console.log("index.html 有权限");
          frontNotificationPush();
        } else {
          alert("请允许通知");
        }
      });

      // 轮训发送通知
      // const loopOptions = {
      //   body: "You successfully subscribed to our LOOP Notification service!",
      //   tag: "confirm-notification",
      // };
      // const loopNotificationPush = () => {
      //   new Notification("loopNotificationPush", loopOptions);
      //   setTimeout(loopNotificationPush, 5000);
      // };
      // if (Notification.permission === "default") {
      //   console.log("index.html 没有权限");
      //   Notification.requestPermission().then((permission) => {
      //     if (permission === "granted") {
      //       loopNotificationPush();
      //     } else {
      //       alert("请允许通知");
      //     }
      //   });
      // } else if (Notification.permission === "granted") {
      //   console.log("index.html 有权限");
      //   loopNotificationPush();
      // } else {
      //   alert("请允许通知");
      // }


      // service worker 消息
      // let i = 0;
      // let registration = null;
      // if ("serviceWorker" in navigator) {
      //   navigator.serviceWorker.ready.then((e) => {
      //     registration = e;
      //   });
      // }
      // const serviceOptions = {
      //   body: "You successfully subscribed to our SERVICE Notification service!",
      //   tag: "confirm-notification",
      // };
      // const serivceNotificationPush = () => {
      //   console.log('serivceNotificationPush running');

      //   if(registration){
      //     registration.showNotification("serivceNotificationPush" + i++, serviceOptions);
      //   }
      //   setTimeout(serivceNotificationPush, 5000);
      // };
      // if (Notification.permission === "default") {
      //   console.log("index.html 没有权限");
      //   Notification.requestPermission().then((permission) => {
      //     if (permission === "granted") {
      //       serivceNotificationPush();
      //     } else {
      //       alert("请允许通知");
      //     }
      //   });
      // } else if (Notification.permission === "granted") {
      //   console.log("index.html 有权限");
      //   serivceNotificationPush();
      // } else {
      //   alert("请允许通知");
      // }

      // 点击发送 service worker 消息
      // const frontServiceNotification = document.querySelector("#front_service_notification");
      // let i = 0;
      // let registration = null;
      // if ("serviceWorker" in navigator) {
      //   navigator.serviceWorker.ready.then((e) => {
      //     registration = e;
      //   });
      // }
      // const frontServiceOptions = {
      //   body: "You successfully subscribed to our FRONT SERVICE Notification service!",
      //   tag: "confirm-notification",
      // };
      // const frontSerivceNotificationPush = () => {
      //   setTimeout(() => {
      //     if(registration){
      //       registration.showNotification("frontSerivceNotificationPush" + i++, frontServiceOptions);
      //     }
      //   }, 5000);

      // };
      // frontServiceNotification.addEventListener("click", () => {
      //   if (Notification.permission === "default") {
      //     console.log("index.html 没有权限");
      //     Notification.requestPermission().then((permission) => {
      //       if (permission === "granted") {
      //         frontSerivceNotificationPush();
      //       } else {
      //         alert("请允许通知");
      //       }
      //     });
      //   } else if (Notification.permission === "granted") {
      //     console.log("index.html 有权限");
      //     frontSerivceNotificationPush();
      //   } else {
      //     alert("请允许通知");
      //   }
      // })


    Notification.requestPermission()
    if (Notification.permission === "default") {
      console.log("index.html 没有权限");
      Notification.requestPermission().then((permission) => {
        if (permission === "granted") {
          console.log("index.html 有权限");

        } else {
          alert("请允许通知");
        }
      });
    } else if (Notification.permission === "granted") {
      console.log("index.html 有权限");

    } else {
      alert("请允许通知");
    }

    function urlBase64ToUint8Array(base64String) {
      var padding = '='.repeat((4 - base64String.length % 4) % 4);
      var base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      var rawData = window.atob(base64);
      var outputArray = new Uint8Array(rawData.length);

      for (var i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }


    navigator.serviceWorker.ready
    .then(function(registration) {
      // Use the PushManager to get the user's subscription to the push service.
      return registration.pushManager.getSubscription()
      .then(async function(subscription) {
        // If a subscription was found, return it.
        if (subscription) {
          console.log('shao has subscription', subscription);
          // subscription.unsubscribe().then(function(successful) {
          //   console.log('shao unsubscribe successful', successful);
          // })
          return subscription;
        }

        // Get the server's public key
        const response = await fetch('./vapidPublicKey');
        console.log('shao response', response);

        const vapidPublicKey = await response.text();
        console.log('shao vapidPublicKey', vapidPublicKey);
        // Chrome doesn't accept the base64-encoded (string) vapidPublicKey yet
        // urlBase64ToUint8Array() is defined in /tools.js
        const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
        console.log('shao convertedVapidKey', convertedVapidKey);

        // Otherwise, subscribe the user (userVisibleOnly allows to specify that we don't plan to
        // send notifications that don't have a visible effect for the user).

        console.log('shao registration.pushManager.subscribe', registration.pushManager.subscribe);
        let res;

        try {
          res = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: convertedVapidKey
          });
        }catch(e) {
          console.log('shao subscribe e code: ', e.code, ' message: ', e.message, ' name: ', e.name);
        }

        console.log('shao res', res);
        return res
      });
    }).then(function(subscription) {
      if(!subscription) {
        return;
      }
      console.log('shao subscription', subscription);

      // Send the subscription details to the server using the Fetch API.
      // fetch('./register', {
      //   method: 'post',
      //   headers: {
      //     'Content-type': 'application/json'
      //   },
      //   body: JSON.stringify({
      //     subscription: subscription
      //   }),
      // });

      const doIt = document.getElementById('doIt')
      const fun = function() {
        const payload = document.getElementById('notification-payload').value;
        const delay = document.getElementById('notification-delay').value;
        const ttl = document.getElementById('notification-ttl').value;

        // Ask the server to send the client a notification (for testing purposes, in actual
        // applications the push notification is likely going to be generated by some event
        // in the server).

        fetch('./sendNotification', {
          method: 'post',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify({
            subscription: subscription,
            payload: payload,
            delay: delay,
            ttl: ttl,
          }),
        });
      };
      doIt.addEventListener('click', fun);

    }).catch((e) => {
      console.log(e);
    })


    </script>
  </body>
</html>
